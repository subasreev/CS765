<!--
simple example of making a visualization from a grade book file
like Mike's, this is designed to be pretty minimal, and not a great vis.

this is meant as a starting point, sketch first, and potentially use this
as a guide to get to something better!  if you use this, give attribution.

written by Alper Sarikaya, April 2017.
-->

<!DOCTYPE html>
<meta charset="utf-8">

<!-- if we had axes, this would be needed to style them correctly -->
<style>

.axis text {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
.tooltip {
  position: absolute;
  width: 200px;
  height: 28px;
  pointer-events: none;
}

</style>
<body>
<script src="//d3js.org/d3.v3.min.js"></script>
<script>

// so we don't accidentally write things off of the canvas, give us a little breathing room
var margins = {top: 20, right: 20, bottom: 40, left: 20};

// modifying these variables should neatly update everything else
var width = 600;
var height = 800;

var txtWidth = 150;
var visWidth = width - txtWidth;

var svg = d3.select('body').append('svg')
    .attr('width', width + margins.left + margins.right)
    .attr('height', height + margins.top + margins.bottom)
    .append('g')
        .attr('transform', 'translate(' + margins.left + ',' + margins.top + ')');

// step out the box positions per assignment
// see <https://github.com/d3/d3-3.x-api-reference/blob/master/Ordinal-Scales.md#ordinal>
var x = d3.scale.ordinal()
    .rangeRoundBands([0, visWidth], 0.2);

// scale for determining name positions
var y = d3.scale.ordinal()
    .rangeRoundBands([0, height], 0.1);

// get the data via an asynchronous call, then call our updateVis function
// see <https://github.com/d3/d3-3.x-api-reference/blob/master/Requests.md#d3_json>
// NOTE: you must run this page from within a webserver to get this to work (security concerns)
//   use something like <https://www.npmjs.com/package/http-server> or 
//   Python's HTTP Server: `python -m SimpleHTTPServer`.
d3.json("../RealisticData/20x10.json", function(error, data) {
    updateVis(data);
});

function updateVis(data) {
    // update the scales now that we know domain variables
    x.domain(d3.range(0, 80));
    y.domain(data.assignments.map(function(d) { return d.name; }));

    // now, create a group for each student
    // see <https://bost.ocks.org/mike/selection/> and <https://bost.ocks.org/mike/join/>
    //   for information on how data joins work -- since we're only adding data, we jump
    //   straight to data().enter(); we don't care about updating existing data or 
    //   removing old data.  
    // We have to have a general .selectAll() before calling data, regardless.

    var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

    var newAssignments = svg.selectAll('g.assignment')
        .data(data.assignments).enter()
        .append('g')
            .attr('class', 'assigment')
            .attr('transform', function(d) { 
            return 'translate(0,' + y(d.name) + ')'
            });

    // add a node to display the student's name
    newAssignments.append('text')
        .text(function(d) { return d.name; });

    // group the assignment vis together
    var studentGrps = newAssignments.append('g')
        .attr('class', 'students')
        .attr('transform', 'translate(' + txtWidth + ',0)');

    // working....
    var xValue = function(d) {return d.score;}
    var xMap = function(d) { return x(xValue(d));} // data -> display

     // now, assign a group for every assignment (for every student, so this makes a 2D selection)
    var students = studentGrps.selectAll('g.student')
	.data(function(d,i){
        return [].concat(data.students.map(function (student) {return (student.grades[i]);}))}).enter()
        .append('g')
        ;


    // draw this first so we can put text on top
    students.append('circle')
	.attr('class', 'student')
        .attr("r", 3.5)
        .attr("cx", xMap)
        .attr("cy", 0)
	.attr("cy", function(d){return 'translate(0' + ',' + y(this.parentNode.parentNode.__data__.name) + ')';})
	.style('fill', '#cc0')
	.on("mouseover", function(d) {
		  tooltip.transition()
		       .duration(200)
		       .style("opacity", .9);
		  tooltip.html(d.score)
		       .style("left", (d3.event.pageX + 5) + "px")
		       .style("top", (d3.event.pageY - 28) + "px");
	      })
	.on("mouseout", function(d) {
		  tooltip.transition()
		       .duration(500)
		       .style("opacity", 0);
	      });

}

</script>
